<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Ukno Club</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="branding">
                <img src="assets/logo.png" alt="Ukno Club" class="logo">
                <h1><span id="welcomeMessagePrefix">Welcome back</span>, <span class="username" id="loggedInUsername">User</span>!</h1>
            </div>
            <nav class="user-nav">
                <a href="profile.html" class="profile-link">Profile</a>
                <a href="auth.html" class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </nav>
        </header>

        <main class="dashboard-content">

            <section class="roadmap-section">
                 <h2><i class="fas fa-map-signs"></i> Data Science Roadmap</h2>
                 <div id="dataScienceRoadmap" class="roadmap-cards-grid">
                     <p class="no-progress-message">Loading roadmap...</p>
                 </div>
             </section>

            <section class="recommended-section">
                 <h2><i class="fas fa-arrow-right"></i> Your Next Step</h2>
                 <div id="recommendedLearningContent">
                      <p class="no-progress-message">Finding your next topic...</p>
                 </div>
             </section>


            <section class="continue-section">
                <h2><i class="fas fa-play-circle"></i> Continue Learning</h2>
                 <div id="continueLearningContent">
                     <p class="no-progress-message">Start a course to see your progress here!</p>
                 </div>
            </section>

             <section class="progress-section">
                 <h2><i class="fas fa-chart-line"></i> My Learning Progress</h2>
                 <div class="progress-cards" id="learningProgressCards">
                     <p class="no-progress-message">Loading progress...</p>
                 </div>
             </section>


            <section class="actions-section">
                <h2><i class="fas fa-bolt"></i> Quick Access</h2>
                <div class="action-grid">
                    <a href="courses.html" class="action-card">
                        <i class="fas fa-book-open"></i>
                        <span>Browse Courses</span>
                    </a>
                    <a href="notes.html" class="action-card">
                        <i class="fas fa-book"></i>
                        <span>My Notes</span>
                    </a>
                    <a href="feedback.html" class="action-card">
                        <i class="fas fa-comment-alt"></i>
                        <span>Feedback</span>
                    </a>
                </div>
            </section>
        </main>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- Element Selections ---
                const welcomeMessagePrefixSpan = document.getElementById('welcomeMessagePrefix');
                const usernameSpan = document.getElementById('loggedInUsername');
                const logoutBtn = document.getElementById('logoutBtn');
                const learningProgressCardsDiv = document.getElementById('learningProgressCards');
                const continueLearningContentDiv = document.getElementById('continueLearningContent');
                const recommendedLearningContentDiv = document.getElementById('recommendedLearningContent');
                const dataScienceRoadmapDiv = document.getElementById('dataScienceRoadmap');


                // --- localStorage/sessionStorage Keys ---
                const ADMIN_AUTH_KEY = 'adminAuthenticated';
                const LOGGED_IN_USERNAME_KEY = 'loggedInUsername';

                // --- localStorage Keys (Currently used for data loading - WILL BE UPDATED TO USE BACKEND API) ---
                const VIDEO_STORAGE_KEY = 'uknoClubVideoData';
                const USER_PROGRESS_KEY_PREFIX = 'uknoClubProgress-';
                const VIDEO_PROGRESS_KEY_PREFIX = 'ukno-video-progress-';


                // --- Authentication Check ---
                console.log("Checking authentication status on dashboard.html load...");
                const userAuthLocal = localStorage.getItem('userAuthenticated') === 'true';
                const userAuthSession = sessionStorage.getItem('userAuthenticated') === 'true';
                const adminAuthLocal = localStorage.getItem(ADMIN_AUTH_KEY) === 'true';

                if (!userAuthLocal && !userAuthSession && !adminAuthLocal) {
                    console.log("User is not authenticated on dashboard.html, redirecting to auth.html");
                    window.location.replace("auth.html#login");
                    return;
                } else {
                    console.log("User is authenticated on dashboard.html, loading dashboard content.");
                    let loggedInUsername = 'User';
                     if (adminAuthLocal) {
                         loggedInUsername = 'Admin';
                     } else if (localStorage.getItem(LOGGED_IN_USERNAME_KEY)) {
                         loggedInUsername = localStorage.getItem(LOGGED_IN_USERNAME_KEY);
                     } else if (sessionStorage.getItem(LOGGED_IN_USERNAME_KEY)) {
                         loggedInUsername = sessionStorage.getItem(LOGGED_IN_USERNAME_KEY);
                     }

                    if (usernameSpan && loggedInUsername) {
                        usernameSpan.textContent = loggedInUsername;
                    }

                    // --- Determine "Welcome" vs "Welcome back" ---
                    const userProgressCheck = loadUserProgress(); // Load progress from localStorage (temporary)
                    const hasProgress = Object.keys(userProgressCheck).length > 0;

                    if (welcomeMessagePrefixSpan) {
                        if (hasProgress) {
                            welcomeMessagePrefixSpan.textContent = 'Welcome back';
                        } else {
                            welcomeMessagePrefixSpan.textContent = 'Welcome';
                        }
                    }
                }

                // --- Logout Functionality ---
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log("Logging out...");
                        localStorage.removeItem('userAuthenticated');
                        sessionStorage.removeItem('userAuthenticated');
                        localStorage.removeItem('adminAuthenticated');
                        localStorage.removeItem('loggedInUsername');
                        sessionStorage.removeItem('loggedInUsername');
                        window.location.replace("index.html");
                    });
                }

                // --- NOTE: The functions below currently load data from localStorage. ---
                // --- We will update these in a future step to fetch data from the backend API. ---
                // --- You may see errors related to these if localStorage is empty/missing data. ---


                // --- Function to Load All Video Data (Currently from localStorage) ---
                function loadAllVideosData() {
                    const videosJson = localStorage.getItem(VIDEO_STORAGE_KEY);
                    try {
                        return videosJson ? JSON.parse(videosJson) : [];
                    } catch (e) {
                        console.error("Error parsing video data from localStorage:", e);
                        return [];
                    }
                }

                // --- Function to Load User Progress Data (Currently from localStorage) ---
                function loadUserProgress() {
                    const loggedInUsername = localStorage.getItem('loggedInUsername') || sessionStorage.getItem('loggedInUsername');
                    if (loggedInUsername && loggedInUsername !== 'Guest') {
                        const progressJson = localStorage.getItem(USER_PROGRESS_KEY_PREFIX + loggedInUsername);
                        try {
                             return progressJson ? JSON.parse(progressJson) : {};
                        } catch (e) {
                             console.error("Error parsing user progress from localStorage:", e);
                             return {};
                        }
                    }
                    return {};
                }

                // --- Helper to format seconds into MM:SS ---
                 function formatTime(seconds) {
                     if (isNaN(seconds) || seconds < 0) return '00:00';
                     const minutes = Math.floor(seconds / 60);
                     const remainingSeconds = Math.floor(seconds % 60);
                     const paddedMinutes = minutes < 10 ? '0' + minutes : minutes;
                     const paddedSeconds = remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds;
                     return `${paddedMinutes}:${paddedSeconds}`;
                 }

                 // --- Helper to format seconds into HH:MM:SS ---
                 function formatTimeToHHMMSS(totalSeconds) {
                    if (isNaN(totalSeconds) || totalSeconds < 0) return '00:00:00';
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = Math.floor(totalSeconds % 60);

                    const paddedHours = hours < 10 ? '0' + hours : hours;
                    const paddedMinutes = minutes < 10 ? '0' + minutes : minutes;
                    const paddedSeconds = seconds < 10 ? '0' + seconds : seconds;

                    return hours > 0 ? `${paddedHours}:${paddedMinutes}:${paddedSeconds}` : `${paddedMinutes}:${paddedSeconds}`;
                 }


                // --- Function to Calculate and Display Learning Progress (Currently from localStorage) ---
                function displayLearningProgress() {
                    const allVideos = loadAllVideosData();
                    const userProgress = loadUserProgress();
                    learningProgressCardsDiv.innerHTML = '';

                    if (allVideos.length === 0) {
                         learningProgressCardsDiv.innerHTML = '<p class="no-progress-message">No course data available. Please check back later.</p>';
                         return;
                    }

                    const modules = {};
                    allVideos.forEach(video => {
                        if (!modules[video.videoModule]) {
                            modules[video.videoModule] = [];
                        }
                        modules[video.videoModule].push(video);
                    });

                    const moduleTitles = {
                        'data-analyst': 'Data Analyst Track',
                        'business-analyst': 'Business Analyst Track',
                        'data-scientist': 'Data Scientist Track',
                        'big-data': 'Big Data & Cloud Tools',
                    };
                    const moduleSymbols = {
                        'data-analyst': 'ðŸŸ¦',
                        'business-analyst': 'ðŸŸ¨',
                        'data-scientist': 'ðŸŸ¥',
                        'big-data': 'ðŸŸ©',
                    };

                    const moduleKeys = Object.keys(modules).sort();

                    if (moduleKeys.length === 0) {
                         learningProgressCardsDiv.innerHTML = '<p class="no-progress-message">No course modules defined yet.</p>';
                         return;
                    }

                    moduleKeys.forEach(moduleKey => {
                        const moduleVideos = modules[moduleKey];
                        const totalVideosInModule = moduleVideos.length;
                        let completedVideosInModule = 0;

                        moduleVideos.forEach(video => {
                            if (userProgress[video.topicId] && userProgress[video.topicId].completed) {
                                completedVideosInModule++;
                            }
                        });

                        const completionPercentage = totalVideosInModule > 0
                            ? Math.round((completedVideosInModule / totalVideosInModule) * 100)
                            : 0;

                        const moduleTitle = moduleTitles[moduleKey] || `${moduleKey} Track`;
                         const moduleSymbol = moduleSymbols[moduleKey] || ' ';

                        const progressCard = document.createElement('div');
                        progressCard.classList.add('progress-card');
                        progressCard.innerHTML = `
                            <h3>${moduleSymbol} ${moduleTitle}</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${completionPercentage}%"></div>
                            </div>
                            <span class="progress-percent">${completionPercentage}% Complete</span>
                            <div class="next-topic">${completedVideosInModule} of ${totalVideosInModule} videos completed</div>
                        `;
                        learningProgressCardsDiv.appendChild(progressCard);
                    });
                }

                // --- Function to Display Continue Learning Section (Currently from localStorage) ---
                 function displayContinueLearning() {
                     continueLearningContentDiv.innerHTML = '';

                     const allVideos = loadAllVideosData();
                     let mostRecentlyWatchedVideo = null;
                     let latestTimestamp = null;
                     let lastSavedTime = 0;

                     const loggedInUsername = localStorage.getItem('loggedInUsername') || sessionStorage.getItem('loggedInUsername');
                     if (!loggedInUsername || loggedInUsername === 'Guest') {
                          continueLearningContentDiv.innerHTML = '<p class="no-progress-message">Log in to track your progress.</p>';
                         return;
                     }

                     allVideos.forEach(video => {
                          const userVideoProgressKey = VIDEO_PROGRESS_KEY_PREFIX + loggedInUsername + '-' + video.topicId;
                          const savedProgressJson = localStorage.getItem(userVideoProgressKey);

                          if (savedProgressJson) {
                             try {
                                 const progressData = JSON.parse(savedProgressJson);
                                  const userProgress = loadUserProgress();
                                  const isCompleted = userProgress[video.topicId] && userProgress[video.topicId].completed;

                                 if (!isCompleted && progressData.timestamp && progressData.time !== undefined && parseFloat(progressData.time) > 0) {
                                      const currentTimestamp = new Date(progressData.timestamp);
                                      if (latestTimestamp === null || currentTimestamp > latestTimestamp) {
                                           latestTimestamp = currentTimestamp;
                                           mostRecentlyWatchedVideo = video;
                                           lastSavedTime = parseFloat(progressData.time);
                                      }
                                 }
                             } catch (e) {
                                 console.error(`Failed to parse progress for video ${video.topicId} for user ${loggedInUsername}:`, e);
                                 localStorage.removeItem(userVideoProgressKey);
                             }
                          }
                      });

                     if (mostRecentlyWatchedVideo) {
                          const continueCard = document.createElement('a');
                          continueCard.classList.add('video-card');
                          continueCard.href = `courses.html?video=${mostRecentlyWatchedVideo.topicId}`;

                          const totalDurationSeconds = mostRecentlyWatchedVideo.totalDuration;
                          let remainingText = 'Duration N/A';
                          let progressPercent = 0;

                         if (totalDurationSeconds !== undefined && !isNaN(totalDurationSeconds) && totalDurationSeconds > 0) {
                             const remainingDuration = totalDurationSeconds - lastSavedTime;
                              const displayRemainingSeconds = Math.max(0, remainingDuration);
                              remainingText = `${formatTime(displayRemainingSeconds)} remaining`;
                              progressPercent = Math.round((lastSavedTime / totalDurationSeconds) * 100);
                              progressPercent = Math.min(100, Math.max(0, progressPercent));
                         }

                           const lastViewedDate = latestTimestamp ? latestTimestamp.toLocaleString() : 'unknown date';

                          continueCard.innerHTML = `
                               <div class="video-info">
                                   <h3>${mostRecentlyWatchedVideo.videoTitle}</h3>
                                   <p class="video-desc">${mostRecentlyWatchedVideo.videoDescription || 'No description available.'}</p>
                                   <div class="video-meta">
                                      <span><i class="far fa-clock"></i> ${remainingText}</span>
                                      <span><i class="far fa-calendar"></i> Last viewed: ${lastViewedDate}</span>
                                   </div>
                               </div>
                               <div class="play-btn"><i class="fas fa-play"></i></div>
                          `;
                          continueLearningContentDiv.appendChild(continueCard);

                     } else {
                          continueLearningContentDiv.innerHTML = '<p class="no-progress-message">Start a course to see your progress here!</p>';
                      }
                 }


                // --- Function to Display Recommended Next Topic (Currently based on localStorage) ---
                 function displayRecommendedLearning() {
                     recommendedLearningContentDiv.innerHTML = '';

                     const allVideos = loadAllVideosData();
                     const userProgress = loadUserProgress();
                     let recommendedVideo = null;

                     const loggedInUsername = localStorage.getItem('loggedInUsername') || sessionStorage.getItem('loggedInUsername');
                      if (!loggedInUsername || loggedInUsername === 'Guest') {
                           recommendedLearningContentDiv.innerHTML = '<p class="no-progress-message">Log in to get recommendations.</p>';
                          return;
                      }

                      let mostRecentlyWatchedVideo = null;
                      let latestTimestamp = null;

                      if (loggedInUsername) {
                         allVideos.forEach(video => {
                              const userVideoProgressKey = VIDEO_PROGRESS_KEY_PREFIX + loggedInUsername + '-' + video.topicId;
                              const savedProgressJson = localStorage.getItem(userVideoProgressKey);
                             if (savedProgressJson) {
                                  try {
                                      const progressData = JSON.parse(savedProgressJson);
                                     if (progressData.timestamp) {
                                          const currentTimestamp = new Date(progressData.timestamp);
                                          if (latestTimestamp === null || currentTimestamp > latestTimestamp) {
                                               latestTimestamp = currentTimestamp;
                                               mostRecentlyWatchedVideo = video;
                                          }
                                      }
                                  } catch (e) {
                                       console.error(`Failed to parse progress for video ${video.topicId} for user ${loggedInUsername}:`, e);
                                  }
                             }
                         });
                     }

                     if (mostRecentlyWatchedVideo) {
                          const isCompleted = userProgress[mostRecentlyWatchedVideo.topicId] && userProgress[mostRecentlyWatchedVideo.topicId].completed;

                         if (isCompleted) {
                              const moduleVideos = allVideos.filter(v => v.videoModule === mostRecentlyWatchedVideo.videoModule)
                                     .sort((a, b) => a.videoTitle.localeCompare(b.videoTitle));

                              const currentIndex = moduleVideos.findIndex(v => v.topicId === mostRecentlyWatchedVideo.topicId);

                              for (let i = currentIndex + 1; i < moduleVideos.length; i++) {
                                   const nextVideo = moduleVideos[i];
                                   if (!userProgress[nextVideo.topicId] || !userProgress[nextVideo.topicId].completed) {
                                       recommendedVideo = nextVideo;
                                       break;
                                   }
                              }
                          }
                      }

                      if (!recommendedVideo) {
                           const modules = {};
                            allVideos.forEach(video => {
                                if (!modules[video.videoModule]) {
                                    modules[video.videoModule] = [];
                                }
                                modules[video.videoModule].push(video);
                           });
                           const moduleKeys = Object.keys(modules).sort();

                           for (const moduleKey of moduleKeys) {
                                const moduleVideos = allVideos.filter(v => v.videoModule === moduleKey)
                                      .sort((a, b) => a.videoTitle.localeCompare(b.videoTitle));

                                for (const video of moduleVideos) {
                                     if (!userProgress[video.topicId] || !userProgress[video.topicId].completed) {
                                         recommendedVideo = video;
                                         break;
                                      }
                                }
                                if (recommendedVideo) break;
                            }
                      }

                     if (recommendedVideo) {
                          const recommendedCard = document.createElement('a');
                           recommendedCard.classList.add('video-card');
                           recommendedCard.href = `courses.html?video=${recommendedVideo.topicId}`;

                          recommendedCard.innerHTML = `
                               <div class="video-info">
                                   <h3>${recommendedVideo.videoTitle}</h3>
                                   <p class="video-desc">${recommendedVideo.videoDescription || 'No description available.'}</p>
                                   <div class="video-meta">
                                       <span><i class="fas fa-book-open"></i> Module: ${recommendedVideo.videoModule}</span>
                                   </div>
                               </div>
                               <div class="play-btn"><i class="fas fa-arrow-right"></i></div>
                          `;
                          recommendedLearningContentDiv.appendChild(recommendedCard);

                      } else {
                          recommendedLearningContentDiv.innerHTML = '<p class="no-progress-message">You have completed all available videos! ðŸŽ‰ Check back later for new content.</p>';
                       }
                  }

                // --- Function to Display Data Science Roadmap (Populated with styled cards, not links) ---
                 function displayDataScienceRoadmap() {
                     // Sample hardcoded data for the Data Science roadmap tracks
                     const dataScienceTracks = [
                         { title: "Data Analyst Track", description: "Start here! Learn Excel, Statistics, SQL, Power BI, and Tableau." },
                         { title: "Business Analyst Track", description: "Build on fundamentals with business concepts and tools." },
                         { title: "Data Scientist Track", description: "Dive into advanced statistics, machine learning, and algorithms." },
                         { title: "Big Data & Cloud Tools", description: "Explore technologies for large datasets and cloud platforms." }
                     ];

                     dataScienceRoadmapDiv.innerHTML = ''; // Clear placeholder

                     dataScienceTracks.forEach(track => {
                         const roadmapCard = document.createElement('div'); // Changed from 'a' to 'div'
                         roadmapCard.classList.add('roadmap-card'); // Use the existing roadmap-card class

                         roadmapCard.innerHTML = `
                             <h3>${track.title}</h3>
                             <p>${track.description}</p>
                         `;
                         dataScienceRoadmapDiv.appendChild(roadmapCard);
                     });

                      // Add a visual separator or arrow indicator between cards if desired via CSS
                      // The grid layout provides gaps, but explicit connectors would need more complex HTML/CSS or SVG.
                 }


                // --- Initial Load and Display ---
                if (userAuthLocal || userAuthSession || adminAuthLocal) {
                     displayLearningProgress();
                     displayContinueLearning();
                     displayRecommendedLearning();
                     displayDataScienceRoadmap(); // Display the roadmap section
                }
            });
        </script>
    </body>
    </html>