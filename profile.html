<script>
        document.addEventListener('DOMContentLoaded', function() {
            const displayUsernameSpan = document.getElementById('displayUsername');
            const displayFullNameSpan = document.getElementById('displayFullName');
            const displayEmailSpan = document.getElementById('displayEmail');

            const profileDisplayDiv = document.getElementById('profileDisplay');
            const profileEditForm = document.getElementById('profileEditForm');

            const editProfileBtn = document.getElementById('editProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');

            const editUsernameInput = document.getElementById('editUsername');
            const editFullNameInput = document.getElementById('editFullName');
            const editEmailInput = document.getElementById('editEmail');

            const profileMessage = document.getElementById('profileMessage');
            const logoutBtn = document.getElementById('logoutBtn'); // Get the logout button

            // --- localStorage Key (Consistent with auth.html) ---
            const USERS_STORAGE_KEY = 'uknoClubUsers';

            // --- Get logged-in username ---
             const loggedInUsername = localStorage.getItem('loggedInUsername') || (localStorage.getItem('adminAuthenticated') ? 'Admin' : null);

             // Redirect if somehow loggedInUsername is missing despite authentication check
              if (!loggedInUsername) {
                   window.location.href = "auth.html#login";
                   return; // Stop script execution
              }


            // --- Helper function to get user data from localStorage ---
             function getUsers() {
                 const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
                 try {
                     return usersJson ? JSON.parse(usersJson) : {};
                 } catch (e) {
                     console.error("Error parsing users data from localStorage:", e);
                     return {}; // Return empty object if parsing fails
                 }
             }

            // --- Helper function to save user data to localStorage ---
             function saveUsers(usersObject) {
                 localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(usersObject));
             }

             // --- Helper function to show messages ---
             function showMessage(message, type = 'info') {
                 profileMessage.textContent = message;
                 profileMessage.style.color = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--error)' : 'var(--text-secondary)');
                 profileMessage.style.display = 'block';

                 // Hide message after a few seconds for non-error messages
                 if (type !== 'error') {
                     setTimeout(() => {
                         profileMessage.style.display = 'none';
                     }, 5000); // Hide after 5 seconds
                 }
             }

             // --- Helper function to clear messages ---
             // This function was causing the ReferenceError if missing or misplaced
             function clearMessages() {
                 profileMessage.textContent = '';
                 profileMessage.style.display = 'none'; // Ensure message area is hidden
             }


            // --- Function to Load and Display Current User's Profile ---
            function loadAndDisplayProfile() {
                const users = getUsers();
                const currentUser = users[loggedInUsername]; // Get data for the logged-in user

                if (currentUser) {
                    // Populate display fields
                    displayUsernameSpan.textContent = loggedInUsername; // Username is always the key
                    displayFullNameSpan.textContent = currentUser.fullName || 'Not provided'; // Use saved data or default
                    displayEmailSpan.textContent = currentUser.email || 'Not provided'; // Use saved data or default

                    // Populate edit form fields (initial state)
                    editUsernameInput.value = loggedInUsername; // Username input is disabled
                    editFullNameInput.value = currentUser.fullName || '';
                    editEmailInput.value = currentUser.email || '';

                } else {
                    // This case should ideally not happen if authentication worked, but handle it
                    console.error("Current user data not found in localStorage.");
                    profileDisplayDiv.innerHTML = '<p class="error-message">Error loading profile data.</p>';
                    editProfileBtn.style.display = 'none'; // Hide edit button
                }
            }

            // --- Toggle between Display and Edit Mode ---
            function toggleEditMode(isEditing) {
                if (isEditing) {
                    profileDisplayDiv.classList.add('hidden');
                    profileEditForm.classList.remove('hidden');
                    editProfileBtn.style.display = 'none';
                    clearMessages(); // Clear message area when entering edit mode
                } else {
                    profileEditForm.classList.add('hidden');
                    profileDisplayDiv.classList.remove('hidden');
                    editProfileBtn.style.display = 'inline-block'; // Or 'block' depending on CSS
                    clearMessages(); // Clear message area when canceling or after saving
                    loadAndDisplayProfile(); // Reload display to show latest data
                }
            }

            // --- Event Listeners ---
            editProfileBtn.addEventListener('click', function() {
                toggleEditMode(true); // Switch to edit mode
            });

            cancelEditBtn.addEventListener('click', function() {
                toggleEditMode(false); // Switch back to display mode
            });

            profileEditForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission

                clearMessages(); // Clear previous messages - This was the line causing the error!

                console.log("Attempting to save profile changes..."); // Added log for debugging


                const users = getUsers();
                const currentUser = users[loggedInUsername];

                if (currentUser) {
                    // Get updated values from the form
                    const updatedFullName = editFullNameInput.value.trim();
                    const updatedEmail = editEmailInput.value.trim();

                    // Optional: Add validation for email format if desired
                     if (updatedEmail && !/@.+\..+/.test(updatedEmail)) {
                         showMessage("Please enter a valid email address.", 'error');
                         return; // Stop if email is invalid
                     }


                    // Update the user object
                    currentUser.fullName = updatedFullName;
                    currentUser.email = updatedEmail;
                    // Do NOT update password here (should be a separate process)

                    // Save the updated users object back to localStorage
                    saveUsers(users);

                    showMessage("Profile updated successfully!", 'success');

                    // Switch back to display mode after a delay
                    setTimeout(() => {
                        toggleEditMode(false);
                    }, 1000); // Switch after 1 second
                } else {
                    showMessage("Error: Could not save profile data.", 'error');
                }
            });

            // --- Logout Functionality ---
             if (logoutBtn) {
                 logoutBtn.addEventListener('click', function(e) {
                     e.preventDefault(); // Prevent default link behavior
                     // Clear all relevant auth/user info from localStorage
                     localStorage.removeItem('userAuthenticated');
                     localStorage.removeItem('adminAuthenticated');
                     localStorage.removeItem('loggedInUsername');
                     // Add other user-specific localStorage items to clear here if necessary

                     window.location.href = "index.html"; // Redirect to landing page after logout
                 });
             }


            // --- Initial Load ---
            loadAndDisplayProfile(); // Load and display profile data when the page loads
        });
    </script>