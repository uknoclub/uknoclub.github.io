<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Videos - Admin | Ukno Club</title>
    <link rel="stylesheet" href="manage-videos.css"> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> <script>
        // Admin Authentication Check
        const adminAuthenticated = localStorage.getItem('adminAuthenticated');
        if (!adminAuthenticated) {
            window.location.href = "auth.html"; // Redirect to auth page if not admin
        }
    </script>
     <style>
         /* Optional: Adjust input width if HH:MM:SS needs more space */
         #totalDuration {
             width: 120px; /* Adjust as needed */
         }
         /* Adjustments for simplified form layout */
         .video-form {
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Slightly wider columns */
         }
         .form-group label {
             font-size: 0.95rem;
         }
         .form-group input[type="text"],
         .form-group select {
             padding: 12px; /* Slightly larger padding */
             font-size: 1rem;
         }
         .form-actions {
             grid-column: 1 / -1; /* Span across all columns */
             display: flex;
             justify-content: flex-end;
             gap: 15px; /* Increased gap */
             margin-top: 20px;
         }
     </style>
</head>
<body>
    <div class="manage-videos-container">
        <header class="manage-videos-header">
            <div class="branding">
                <img src="assets/logo.png" alt="Ukno Club" class="logo">
                <h1>Manage Videos</h1>
            </div>
            <nav class="header-nav">
                <a href="admin-dashboard.html">Dashboard</a>
                <a href="courses.html">Courses</a> <a href="#" id="adminLogoutBtn">Logout</a> </nav>
        </header>

        <main class="manage-videos-content">
            <section class="video-form-section">
                <h2 id="formTitle"><i class="fas fa-plus-circle"></i> Add New Video</h2>
                <form id="videoForm" class="video-form">
                    <input type="hidden" id="videoId">
                     <input type="hidden" id="topicId">


                    <div class="form-group">
                         <label for="videoTitle">Display Name (e.g., Statistics Fundamentals):</label>
                         <input type="text" id="videoTitle" required placeholder="Enter the video/topic name">
                    </div>

                    <div class="form-group">
                         <label for="youtubeLink">YouTube Link (Video or Playlist URL):</label>
                         <input type="text" id="youtubeLink" required placeholder="Paste the full YouTube URL here">
                    </div>

                     <div class="form-group">
                         <label for="videoModule">Module/Track:</label>
                         <select id="videoModule" required>
                              <option value="">--Select Module--</option>
                              <option value="data-analyst">Data Analyst Track</option>
                              <option value="business-analyst">Business Analyst Track</option>
                              <option value="data-scientist">Data Scientist Track</option>
                              <option value="big-data">Big Data & Cloud</option>
                         </select>
                     </div>

                     <div class="form-group">
                         <label for="videoDescription">Short Description:</label>
                         <input type="text" id="videoDescription" placeholder="e.g., Descriptive stats, probability...">
                     </div>


                     <div class="form-group">
                          <label for="totalDuration">Total Duration (HH:MM:SS):</label>
                          <input type="text" id="totalDuration" placeholder="e.g., 01:30:45">
                     </div>


                    <div class="form-actions">
                        <button type="submit" class="add-button"><i class="fas fa-save"></i> Save Video</button>
                         <button type="button" class="cancel-button" id="cancelEditBtn" style="display: none;"><i class="fas fa-times-circle"></i> Cancel Edit</button>
                    </div>
                </form>
             <p id="formMessage" class="no-videos-message" style="display: none; margin-top: 10px;"></p> </section>

            <section class="video-list-section">
                <h2><i class="fas fa-list"></i> Existing Videos</h2>
                <table class="video-table">
                    <thead>
                        <tr>
                            <th>Display Name</th> <th>Type</th>
                            <th>YouTube ID</th> <th>Description</th>
                            <th>Module</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="videosTableBody">
                        <tr><td colspan="7" class="no-videos-message">Loading videos...</td></tr> </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const videoForm = document.getElementById('videoForm');
            const videoIdInput = document.getElementById('videoId'); // Hidden internal ID field
             const topicIdInput = document.getElementById('topicId'); // Hidden unique topic ID field (derived from title or generated)
            const videoTitleInput = document.getElementById('videoTitle'); // Display Name text input
            const youtubeLinkInput = document.getElementById('youtubeLink'); // New YouTube Link input
            const videoDescriptionInput = document.getElementById('videoDescription');
            const videoModuleSelect = document.getElementById('videoModule');
            const totalDurationInput = document.getElementById('totalDuration');
            const saveButton = videoForm.querySelector('.add-button');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const formTitle = document.getElementById('formTitle');
            const videosTableBody = document.getElementById('videosTableBody');
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            const formMessageArea = document.getElementById('formMessage');


            // --- localStorage Keys ---
            const VIDEO_STORAGE_KEY = 'uknoClubVideoData';
             const USER_PROGRESS_KEY_PREFIX = 'uknoClubProgress-'; // For deleting associated progress
             const VIDEO_NOTES_KEY_PREFIX = 'video-notes-'; // For deleting associated notes
             const VIDEO_PROGRESS_KEY_PREFIX = 'ukno-video-progress-'; // For deleting associated progress time


            // --- Helper Function to Load Videos from localStorage ---
            function loadVideos() {
                const videosJson = localStorage.getItem(VIDEO_STORAGE_KEY);
                try {
                    return videosJson ? JSON.parse(videosJson) : [];
                } catch (e) {
                    console.error("Error parsing video data from localStorage:", e);
                    return []; // Return empty array if parsing fails
                }
            }

            // --- Helper Function to Save Videos to localStorage ---
            function saveVideos(videosArray) {
                localStorage.setItem(VIDEO_STORAGE_KEY, JSON.stringify(videosArray));
            }

             // --- Helper Function to Show Messages ---
             function showMessage(message, type = 'info') {
                 formMessageArea.textContent = message;
                 formMessageArea.style.color = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--error)' : 'var(--text-secondary)');
                 formMessageArea.style.display = 'block';

                 // Hide message after a few seconds for non-error messages
                 if (type !== 'error') {
                     setTimeout(() => {
                         formMessageArea.style.display = 'none';
                     }, 5000); // Hide after 5 seconds
                 }
             }

             // --- Helper to parse HH:MM:SS to seconds ---
             function parseDurationToSeconds(durationString) {
                 if (!durationString) return 0;
                 const parts = durationString.split(':').map(Number);
                 if (parts.some(isNaN)) return 0; // Return 0 if any part is not a number

                 let seconds = 0;
                 if (parts.length === 1) { // SS
                     seconds = parts[0];
                 } else if (parts.length === 2) { // MM:SS
                     seconds = parts[0] * 60 + parts[1];
                 } else if (parts.length === 3) { // HH:MM:SS
                     seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
                 }
                 return seconds;
             }

             // --- Helper to format seconds into HH:MM:SS ---
             function formatSecondsToHHMMSS(totalSeconds) {
                 if (isNaN(totalSeconds) || totalSeconds < 0) return '00:00:00';
                 const hours = Math.floor(totalSeconds / 3600);
                 const minutes = Math.floor((totalSeconds % 3600) / 60);
                 const seconds = Math.floor(totalSeconds % 60);

                 const paddedHours = hours < 10 ? '0' + hours : hours;
                 const paddedMinutes = minutes < 10 ? '0' + minutes : minutes;
                 const paddedSeconds = seconds < 10 ? '0' + seconds : seconds;

                 // Only include hours if there are any
                 return hours > 0 ? `${paddedHours}:${paddedMinutes}:${paddedSeconds}` : `${paddedMinutes}:${paddedSeconds}`;
             }

             // --- Helper to extract YouTube ID and Type from URL ---
             function getYouTubeIdAndType(url) {
                 let videoId = null;
                 let videoType = null;

                 const videoMatch = url.match(/(?:http(?:s)?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([a-zA-Z0-9_-]+)(?:&.*)?/);
                 const playlistMatch = url.match(/(?:http(?:s)?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:playlist\?list=|p\/)([a-zA-Z0-9_-]+)(?:&.*)?/);

                 if (videoMatch && videoMatch[1]) {
                     videoId = videoMatch[1];
                     videoType = 'video';
                 } else if (playlistMatch && playlistMatch[1]) {
                     videoId = playlistMatch[1];
                     videoType = 'playlist';
                 } else {
                     // Basic fallback if no standard match - assume it might be just the ID?
                      // Or handle as an error
                     if (url.length > 5 && !url.includes(' ')) { // Basic check for something that might be an ID
                           videoId = url;
                           videoType = 'video'; // Default to video if unclear
                           console.warn("Could not parse standard YouTube URL, assuming input is just the ID:", url);
                     } else {
                          console.error("Invalid or unparseable YouTube URL:", url);
                          showMessage("Invalid or unparseable YouTube URL.", 'error');
                          return { youtubeId: null, videoType: null };
                     }
                 }

                 return { youtubeId: videoId, videoType: videoType };
             }


            // --- Function to Render Video Table ---
            function renderVideoTable() {
                const videos = loadVideos();
                videosTableBody.innerHTML = ''; // Clear current table

                if (videos.length === 0) {
                    videosTableBody.innerHTML = '<tr><td colspan="7" class="no-videos-message">No videos added yet.</td></tr>'; // Updated colspan
                } else {
                    videos.forEach(video => {
                        const row = document.createElement('tr');
                         // Note: We are not displaying the internal 'id' or 'topicId' in the table by default for simplicity
                         // The 'Actions' buttons use the internal 'id' to find the object.
                        row.innerHTML = `
                            <td data-label="Display Name">${video.videoTitle}</td>
                            <td data-label="Type">${video.videoType === 'video' ? 'Single' : 'Playlist'}</td>
                            <td data-label="YouTube ID">${video.youtubeId}</td> <td data-label="Description">${video.videoDescription || '-'}</td>
                            <td data-label="Module">${video.videoModule}</td>
                            <td data-label="Duration">${video.totalDuration !== undefined ? formatSecondsToHHMMSS(video.totalDuration) : '-'}</td>
                            <td data-label="Actions" class="video-actions">
                                <button class="edit-video-btn" data-id="${video.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="delete-video-btn" data-id="${video.id}"><i class="fas fa-trash-alt"></i> Delete</button>
                            </td>
                        `;
                        videosTableBody.appendChild(row);
                    });

                    // Attach event listeners to edit and delete buttons after rendering
                    attachVideoActionListeners();
                }
            }

            // --- Function to Attach Event Listeners to Action Buttons ---
            function attachVideoActionListeners() {
                document.querySelectorAll('.edit-video-btn').forEach(button => {
                    button.addEventListener('click', handleEditVideo);
                });
                document.querySelectorAll('.delete-video-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteVideo);
                });
            }


            // --- Handle Form Submission (Add/Edit) ---
            videoForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const id = videoIdInput.value; // Check if we are editing (internal ID exists)
                 const existingTopicId = topicIdInput.value; // Get existing topic ID if editing

                const videoTitle = videoTitleInput.value.trim(); // Get display name
                const youtubeLink = youtubeLinkInput.value.trim(); // Get the full link
                const videoDescription = videoDescriptionInput.value.trim();
                const videoModule = videoModuleSelect.value;
                const durationString = totalDurationInput.value.trim();

                // Basic validation for required fields
                 if (!videoTitle || !youtubeLink || !videoModule) {
                     showMessage("Please fill Display Name, YouTube Link, and Module.", 'error');
                     return;
                 }
                if (videoModule === "") {
                     showMessage("Please select a Module.", 'error');
                     return;
                }


                // Parse YouTube link
                const { youtubeId, videoType } = getYouTubeIdAndType(youtubeLink);
                 if (!youtubeId || !videoType) {
                      // Error message already shown by getYouTubeIdAndType
                      return;
                 }


                // Parse and validate duration
                 const parsedDuration = parseDurationToSeconds(durationString);
                 if (durationString !== '' && parsedDuration === 0 && durationString !== '0' && durationString !== '0:00' && durationString !== '00:00' && durationString !== '0:00:00' && durationString !== '00:00:00') {
                     showMessage("Invalid duration format (use HH:MM:SS, MM:SS, or SS) or value.", 'error');
                     return;
                 }


                const videos = loadVideos();

                if (id) { // Editing existing video
                    const videoIndex = videos.findIndex(v => v.id === id);
                    if (videoIndex > -1) {
                         // When editing, the topicId should remain the same
                         const topicId = existingTopicId; // Use the existing topic ID


                         // Optional: If you wanted to allow changing the topic ID on edit,
                         // you'd need to validate uniqueness here *and* update all user progress/notes
                         // associated with the OLD topic ID to the NEW topic ID (complex!).
                         // For simplification, we keep the topic ID fixed on edit.


                        videos[videoIndex] = {
                            id: id, // Keep the original internal ID
                            topicId: topicId, // Keep the original topic ID
                            videoType: videoType, // Use type inferred from link
                            youtubeId: youtubeId, // Use ID extracted from link
                            videoTitle: videoTitle, // Use display name
                            videoDescription: videoDescription,
                            videoModule: videoModule,
                            totalDuration: parsedDuration // Save parsed duration (in seconds)
                        };
                        showMessage("Video updated successfully!", 'success');
                    } else {
                         showMessage("Error: Video not found for editing.", 'error');
                    }
                } else { // Adding new video
                     // Generate a unique topic ID for a new entry
                      // A simple slug from the title + random string might be better than just random
                      const generatedTopicId = videoTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
                      // Add a random suffix to ensure uniqueness, especially for identical titles
                      const topicId = generatedTopicId + '-' + Math.random().toString(36).substring(2, 8);


                     // Check if this generated topicId already exists (unlikely with random suffix, but good practice)
                     const duplicateTopic = videos.find(v => v.topicId === topicId);
                     if (duplicateTopic) {
                         // If somehow duplicated, try generating a new one or show error
                         console.warn("Generated topic ID already exists, trying again or manual intervention might be needed.");
                         // For simplicity here, we'll just add it, relying on the random suffix for uniqueness.
                         // A more robust app would re-generate or prompt the user.
                     }


                    const newVideo = {
                        id: Date.now().toString() + Math.random().toString(16).slice(2), // Unique internal ID
                        topicId: topicId, // Generated unique topic ID
                        videoType: videoType, // Use type inferred from link
                        youtubeId: youtubeId, // Use ID extracted from link
                        videoTitle: videoTitle, // Use display name
                        videoDescription: videoDescription,
                        videoModule: videoModule,
                         totalDuration: parsedDuration // Save parsed duration (in seconds)
                    };
                    videos.push(newVideo);
                    showMessage("Video added successfully!", 'success');
                }

                saveVideos(videos); // Save the updated array
                renderVideoTable(); // Re-render the table
                resetForm(); // Clear the form

            });


            // --- Handle Edit Button Click ---
            function handleEditVideo() {
                const videoIdToEdit = this.getAttribute('data-id');
                const videos = loadVideos();
                const videoToEdit = videos.find(v => v.id === videoIdToEdit);

                if (videoToEdit) {
                    // Populate the form with video data
                    videoIdInput.value = videoToEdit.id;
                     topicIdInput.value = videoToEdit.topicId; // Store the existing topic ID in the hidden field
                    videoTitleInput.value = videoToEdit.videoTitle; // Populate display name
                    // Populate YouTube Link field (might be tricky to reconstruct original URL)
                     // Let's populate with the YouTube ID for simplicity, user can replace if needed
                    youtubeLinkInput.value = videoToEdit.youtubeId; // Populate with the extracted ID
                    videoDescriptionInput.value = videoToEdit.videoDescription;
                    videoModuleSelect.value = videoToEdit.videoModule;
                     // Populate duration field by formatting seconds back to HH:MM:SS
                     totalDurationInput.value = videoToEdit.totalDuration !== undefined ? formatSecondsToHHMMSS(videoToEdit.totalDuration) : '';

                    // Change form title and button text
                    formTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Video';
                    saveButton.innerHTML = '<i class="fas fa-save"></i> Update Video';
                    cancelEditBtn.style.display = 'inline-block'; // Show cancel button

                    // Disable the YouTube link field during edit if you don't want it changed easily
                    // Or keep it enabled but the script will parse the new URL on save
                    // Let's keep it enabled for flexibility, the save logic handles parsing the new input.


                     showMessage("Editing video...", 'info');

                } else {
                    showMessage("Error: Video not found for editing.", 'error');
                }
            }


            // --- Handle Cancel Edit Button Click ---
             cancelEditBtn.addEventListener('click', resetForm);


            // --- Handle Delete Button Click ---
            function handleDeleteVideo() {
                if (confirm('Are you sure you want to delete this video entry? This cannot be undone.')) { // Added warning
                    const videoIdToDelete = this.getAttribute('data-id');
                    let videos = loadVideos();

                    // Find the topicId of the video to delete (needed to clean up notes/progress)
                     const videoToDelete = videos.find(v => v.id === videoIdToDelete);
                     const topicIdToDelete = videoToDelete ? videoToDelete.topicId : null;


                    // Filter out the video to delete
                    videos = videos.filter(v => v.id !== videoIdToDelete);

                    saveVideos(videos); // Save the updated array
                    renderVideoTable(); // Re-render the table
                    showMessage("Video deleted successfully!", 'success');
                     resetForm(); // Reset form in case the deleted item was being edited

                     // --- Important: Also remove associated user progress and notes! ---
                     // This is crucial for data consistency. Iterate through all users' progress and notes.
                     // In a real app, the backend would handle this database-level deletion.
                      console.warn(`Frontend Delete: Attempting to remove associated user progress and notes for topic ID: ${topicIdToDelete}`);

                      // Remove notes for this topic
                     if (topicIdToDelete) {
                         localStorage.removeItem(VIDEO_NOTES_KEY_PREFIX + topicIdToDelete);
                         console.log(`Removed notes for ${topicIdToDelete}`);
                     }

                      // Remove progress for this topic from all users (frontend approximation)
                     for (let i = 0; i < localStorage.length; i++) {
                         const key = localStorage.key(i);
                         if (key.startsWith(USER_PROGRESS_KEY_PREFIX)) {
                              try {
                                  const userProgress = JSON.parse(localStorage.getItem(key));
                                  if (userProgress && userProgress[topicIdToDelete]) {
                                      delete userProgress[topicIdToDelete]; // Remove entry for this topic
                                       localStorage.setItem(key, JSON.stringify(userProgress)); // Save updated progress
                                       console.log(`Removed progress for ${topicIdToDelete} from user ${key.replace(USER_PROGRESS_KEY_PREFIX, '')}`);
                                  }
                              } catch (e) {
                                  console.error(`Error parsing user progress for key ${key}:`, e);
                              }
                         }
                     }
                     // Also remove any individual video progress time if user was watching it
                      if (topicIdToDelete) {
                          localStorage.removeItem(VIDEO_PROGRESS_KEY_PREFIX + topicIdToDelete);
                           console.log(`Removed individual video progress time for ${topicIdToDelete}`);
                      }

                }
            }


            // --- Function to Reset the Form ---
            function resetForm() {
                // Clear specific fields manually for more control
                 videoIdInput.value = '';
                 topicIdInput.value = ''; // Clear hidden topic ID
                 videoTitleInput.value = '';
                 youtubeLinkInput.value = '';
                 videoDescriptionInput.value = '';
                 videoModuleSelect.value = ''; // Reset dropdown
                 totalDurationInput.value = '';

                formTitle.innerHTML = '<i class="fas fa-plus-circle"></i> Add New Video';
                saveButton.innerHTML = '<i class="fas fa-save"></i> Save Video';
                cancelEditBtn.style.display = 'none';
                // No topicIdInput to disable anymore in the simplified form


                 showMessage("", 'info'); // Clear message area
                 formMessageArea.style.display = 'none'; // Ensure message area is hidden on reset
            }

             // --- Handle Admin Logout ---
             if(adminLogoutBtn) {
                 adminLogoutBtn.addEventListener('click', function(e) {
                     e.preventDefault();
                     localStorage.removeItem('adminAuthenticated'); // Clear admin auth
                      // Optionally clear other admin-specific localStorage if any
                     window.location.href = "auth.html"; // Redirect to auth page
                 });
             }


            // --- Initial Render ---
            renderVideoTable(); // Load and display videos when the page loads

        });
    </script>

</body>
</html>