<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses - Ukno Club</title> <link rel="stylesheet" href="courses.css"> <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> </head>
<body>
  <div class="course-container">
    <header class="course-header">
        <div class="branding">
            <img src="assets/logo.png" alt="Ukno Club" class="logo">
            <h1 id="pageTitle">Course Catalog</h1> </div>
        <nav class="header-nav">
            <a href="dashboard.html">Dashboard</a>
            <a href="courses.html">Catalog</a> <a href="notes.html">My Notes</a>
            <a href="feedback.html">Feedback</a>
        </nav>
    </header>

    <main class="course-main">
        <div id="courseIndexContent">
             <p id="loadingMessage" class="no-feedback-message">Loading courses...</p>
        </div>


         <div id="videoPlayerContent" class="hidden">
             <div class="back-link-container">
                 <a href="courses.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Catalog</a>
             </div>
              <h2 id="videoTitle">Loading Video...</h2> <div class="video-container">
                  <div id="youtubePlayer"></div> </div>
              <p id="resumeMessage" style="color: var(--text-secondary); font-size: 0.9rem; text-align: center; margin-top: 10px; display: none;"></p> <div id="playlistVideosList" style="margin-top: 20px; display: none;">
                    <h3>Playlist Videos:</h3>
                    <ul id="playlistItems">
                        </ul>
               </div>


              <div class="notes-section">
                  <label for="videoNotes">Take Notes:</label>
                  <textarea id="videoNotes" placeholder="Write your notes here..."></textarea>
              </div>
         </div>

    </main>

     <script>
          // Basic authentication check - redirect if not logged in
          const userAuthenticated = localStorage.getItem('userAuthenticated');
          const adminAuthenticated = localStorage.getItem('adminAuthenticated');
          if (!userAuthenticated && !adminAuthenticated) {
               window.location.href = "auth.html#login"; // Redirect to login form
          }

          // --- localStorage Keys ---
          const VIDEO_STORAGE_KEY = 'uknoClubVideoData'; // From admin interface
          const VIDEO_PROGRESS_KEY_PREFIX = 'ukno-video-progress-'; // User-specific progress { time: ..., timestamp: ... }
          const VIDEO_NOTES_KEY_PREFIX = 'video-notes-'; // Video-specific notes
          const USER_PROGRESS_KEY_PREFIX = 'uknoClubProgress-'; // User-specific completion { videoId: { completed: true, ... } }


          // --- YouTube Player API Script ---
          // This code loads the IFrame Player API asynchronously.
          var tag = document.createElement('script');
          tag.src = "https://www.youtube.com/iframe_api"; // Correct API URL
          var firstScriptTag = document.getElementsByTagName('script')[0];
          firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);


          // --- Global variables for YouTube Player ---
          var player;
          let saveProgressTimer = null; // Timer for saving video progress
          let currentVideoId = null; // To keep track of the currently loaded video topic ID


          // --- Helper Function to Load Videos from localStorage ---
          function loadVideosData() {
              const videosJson = localStorage.getItem(VIDEO_STORAGE_KEY);
              try {
                  return videosJson ? JSON.parse(videosJson) : [];
              } catch (e) {
                  console.error("Error parsing video data from localStorage:", e);
                  return []; // Return empty array if parsing fails
              }
          }

          // --- Function called when the YouTube API is ready. ---
          // This function is called automatically by the API script after it loads.
          function onYouTubeIframeAPIReady() {
               // Initialize the player ONLY if a video ID is present in the URL
               const urlParams = new URLSearchParams(window.location.search);
               const videoIdInUrl = urlParams.get('video');

               if (videoIdInUrl) {
                   currentVideoId = videoIdInUrl; // Set global variable

                   const allVideosData = loadVideosData(); // Load all video data
                   const videoDetails = allVideosData.find(video => video.topicId === currentVideoId);

                   if (videoDetails && videoDetails.youtubeId) {
                       document.getElementById('videoTitle').textContent = videoDetails.videoTitle; // Set the video title
                       document.getElementById('loadingMessage').style.display = 'none'; // Hide loading message (if still visible)


                       // Determine if it's a single video or playlist and load the player
                       const playerOptions = {
                           height: '390',
                           width: '640',
                           playerVars: {
                               'autoplay': 1, // Optional: Autoplay the video
                               'controls': 1,
                               'enablejsapi': 1,
                               'rel': 0, // Hide related videos
                               'showinfo': 0, // Hide video title and uploader info
                               'modestbranding': 1,
                               'playsinline': 1 // Important for mobile
                           },
                           events: {
                               'onReady': onPlayerReady,
                               'onStateChange': onPlayerStateChange,
                                // Optional: Listen for playlist events if needed
                                // 'onPlaylistNext': onPlaylistNext,
                                // 'onPlaylistLoaded': onPlaylistLoaded
                           }
                       };

                       if (videoDetails.videoType === 'video') {
                           playerOptions.videoId = videoDetails.youtubeId;
                       } else if (videoDetails.videoType === 'playlist') {
                           playerOptions.playerVars.listType = 'playlist';
                           playerOptions.playerVars.list = videoDetails.youtubeId;
                           // Optional: Start with a specific video in the playlist
                           // playerOptions.videoId = 'STARTING_VIDEO_ID_IN_PLAYLIST'; // Or get from localStorage progress
                           document.getElementById('playlistVideosList').style.display = 'block'; // Show playlist list area
                       } else {
                           // Handle unknown video type - This might be redundant if handled in DOMContentLoaded, but good fallback
                           document.getElementById('videoPlayerContent').innerHTML = '<p class="no-feedback-message">Unknown video type or video data missing.</p>';
                           document.getElementById('pageTitle').textContent = "Video Error";
                           console.error("Unknown video type or data missing for ID:", currentVideoId, videoDetails);
                           document.getElementById('loadingMessage').style.display = 'none';
                           return; // Stop execution
                       }

                       // Create the YouTube Player
                       player = new YT.Player('youtubePlayer', playerOptions);

                       // Load saved notes for this videoId from localStorage
                       const notesTextarea = document.getElementById('videoNotes');
                       const savedNotes = localStorage.getItem(VIDEO_NOTES_KEY_PREFIX + currentVideoId);
                       if (savedNotes) {
                           notesTextarea.value = savedNotes;
                       }

                       // --- Note Saving (Simple auto-save while typing) ---
                       let saveNotesTimer = null;
                       notesTextarea.addEventListener('input', function() {
                            if (currentVideoId) { // Only save if a video is loaded
                                 clearTimeout(saveNotesTimer);
                                 saveNotesTimer = setTimeout(() => {
                                     localStorage.setItem(VIDEO_NOTES_KEY_PREFIX + currentVideoId, notesTextarea.value);
                                     console.log('Notes auto-saved for video:', currentVideoId);
                                     // Optional: show a small "Notes saved!" message
                                 }, 1000); // Save 1 second after user stops typing
                            }
                       });

                   } else {
                       // Handle case where videoId is in URL but not found in our data
                       document.getElementById('videoPlayerContent').innerHTML = '<p class="no-feedback-message">Video ID from URL not found in course data. Please check Admin > Manage Courses.</p>';
                       document.getElementById('pageTitle').textContent = "Video Error";
                       console.error("Video ID from URL not found in loaded data:", currentVideoId);
                       document.getElementById('loadingMessage').style.display = 'none';
                   }
               }
               // If no videoId in URL, DOMContentLoaded handles showing the catalog index
           }

          // --- Function called when the document is fully loaded and parsed ---
           document.addEventListener('DOMContentLoaded', function() {
               const urlParams = new URLSearchParams(window.location.search);
               const videoIdInUrl = urlParams.get('video');

               const courseIndexContent = document.getElementById('courseIndexContent');
               const videoPlayerContent = document.getElementById('videoPlayerContent');
               const pageTitle = document.getElementById('pageTitle');
                const loadingMessage = document.getElementById('loadingMessage');


               if (videoIdInUrl) {
                   // If a video ID is present, hide the index content and show the video player section
                   courseIndexContent.classList.add('hidden');
                   videoPlayerContent.classList.remove('hidden');
                   pageTitle.textContent = "Watching Course"; // Update page title
                    // Note: loadingMessage is hidden by onYouTubeIframeAPIReady if video data is found
                    // or by the error handling block if not found.
               } else {
                   // If no video ID, show the course index
                   const allVideosData = loadVideosData(); // Load all video data
                    try {
                       renderCourseIndex(allVideosData); // Render the index from loaded data
                    } catch (e) {
                       console.error("Error rendering course index:", e);
                       // Display a user-friendly error message on the page
                       courseIndexContent.innerHTML = '<p class="no-feedback-message">Error loading course index. Please check the console for details.</p>';
                    }
                   courseIndexContent.classList.remove('hidden');
                   videoPlayerContent.classList.add('hidden'); // Ensure video player is hidden
                   pageTitle.textContent = "Course Catalog";
                   loadingMessage.style.display = 'none'; // Hide loading message
               }
           });


           // --- Function to Render the Course Index from Video Data ---
           function renderCourseIndex(videosData) {
               const courseIndexContentDiv = document.getElementById('courseIndexContent');
               courseIndexContentDiv.innerHTML = ''; // Clear current content

               if (videosData.length === 0) {
                    courseIndexContentDiv.innerHTML = '<p class="no-feedback-message">No courses or videos available yet. Admin needs to add them via "Manage Courses".</p>'; // More specific message
                    return;
               }

               // Group videos by module/track
               const modules = {};
               videosData.forEach(video => {
                   if (!modules[video.videoModule]) {
                       modules[video.videoModule] = [];
                   }
                   modules[video.videoModule].push(video);
               });

               // Get module titles and symbols (You might want to store these in localStorage too via admin)
                const moduleTitles = {
                    'data-analyst': '🟦 MODULE 1: Data Analyst Track',
                    'business-analyst': '🟨 MODULE 2: Business Analyst Track',
                    'data-scientist': '🟥 MODULE 3: Data Scientist Track',
                    'big-data': '🟩 BONUS MODULE: Big Data & Cloud Tools',
                    // Add other modules here matching the 'value' in the admin select
                };


               // Render modules and topics
               const moduleKeys = Object.keys(modules).sort(); // Sort modules alphabetically

               if (moduleKeys.length === 0) {
                    courseIndexContentDiv.innerHTML = '<p class="no-feedback-message">No course modules defined in data. Admin needs to add videos with valid modules.</p>';
                    return;
               }


               moduleKeys.forEach(moduleKey => {
                   const moduleVideos = modules[moduleKey];
                    // Sort videos by topic title or another criteria if needed
                    // moduleVideos.sort((a, b) => a.videoTitle.localeCompare(b.videoTitle));

                   const moduleSection = document.createElement('section');
                   moduleSection.classList.add('course-module');

                   moduleSection.innerHTML = `
                       <h2>${moduleTitles[moduleKey] || `❓ MODULE: ${moduleKey}`}</h2>
                       <p class="module-goal">Goal: ${moduleKey} skills...</p> <div class="topic-list-grid">
                           </div>
                   `;

                   const topicListGrid = moduleSection.querySelector('.topic-list-grid');

                   moduleVideos.forEach(video => {
                       const topicCardLink = document.createElement('a');
                       topicCardLink.href = `courses.html?video=${video.topicId}`; // Link to the video player view
                       topicCardLink.classList.add('topic-card');

                       topicCardLink.innerHTML = `
                            <h4>${video.videoTitle}</h4>
                            <p>${video.videoDescription || 'No description available.'}</p>
                            <span class="view-video-link"><i class="fas fa-video"></i> Watch ${video.videoType === 'playlist' ? 'Playlist' : 'Video'}</span>
                       `;
                       topicListGrid.appendChild(topicCardLink);
                   });

                   courseIndexContentDiv.appendChild(moduleSection);
               } ); // Corrected: Removed the extra parenthesis here

               // Add the coming soon message at the end
               const comingSoonMessage = document.createElement('p');
               comingSoonMessage.classList.add('coming-soon');
               comingSoonMessage.textContent = '🚧 More categories and videos coming soon...';
               courseIndexContentDiv.appendChild(comingSoonMessage);

           }


          // --- YouTube Player API Event Handlers ---

          // The API calls this function when the video player is ready.
          function onPlayerReady(event) {
              // This function is called when the player iframe has loaded and the API is ready
              // We can now safely interact with the player object
              console.log('YouTube Player is ready');

              // If it's a playlist, get playlist videos (Optional)
              const allVideosData = loadVideosData(); // Reload data if needed, or pass it from DOMContentLoaded
              const videoDetails = allVideosData.find(video => video.topicId === currentVideoId);

              if (videoDetails && videoDetails.videoType === 'playlist') {
                   console.log("Loaded Playlist:", videoDetails.youtubeId);
                   // You could use player.getPlaylist() here if you need details about playlist items,
                   // but this might be complex client-side without fetching from YouTube API directly.
                   // For now, the default YouTube player controls will manage playlist navigation.
              }


              // Load saved progress
              const savedProgress = localStorage.getItem(VIDEO_PROGRESS_KEY_PREFIX + currentVideoId);

              if (savedProgress) {
                   try {
                       const progressData = JSON.parse(savedProgress); // Parse the saved object
                       const timeToSeek = parseFloat(progressData.time); // Get time from the object

                       // Ensure timeToSeek is a valid number before seeking
                       if (!isNaN(timeToSeek) && timeToSeek > 0) {
                           event.target.seekTo(timeToSeek); // Resume video
                           console.log('Resuming video to:', timeToSeek, 'seconds');
                            const resumeMessageElement = document.getElementById('resumeMessage');
                            if (resumeMessageElement) {
                                // Convert seconds to minutes and seconds for display
                                const minutes = Math.floor(timeToSeek / 60);
                                const seconds = Math.floor(timeToSeek % 60);
                                 // Also display the last viewed date if timestamp is available
                                const timestamp = progressData.timestamp ? new Date(progressData.timestamp).toLocaleString() : 'unknown date';
                                resumeMessageElement.textContent = `Resuming from ${minutes}m ${seconds}s (Last viewed: ${timestamp})`;
                                resumeMessageElement.style.display = 'block';
                                // Hide message after a few seconds
                                setTimeout(() => {
                                    resumeMessageElement.style.display = 'none';
                                }, 8000); // Show a bit longer
                            }
                       }
                   } catch (e) {
                       console.error("Failed to parse saved progress data:", e);
                       // Potentially clear invalid localStorage data
                       localStorage.removeItem(VIDEO_PROGRESS_KEY_PREFIX + currentVideoId);
                   }
              }

              // Optional: Start playing automatically if not resuming (autoplay playerVar handles this)
              // event.target.playVideo();
          }

          // The API calls this function when the player's state changes.
          function onPlayerStateChange(event) {
              if (!currentVideoId) return; // Only save progress if a video is loaded

              // Save video progress (time and timestamp) when playing, paused, or ended
              if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                   const currentTime = player.getCurrentTime();
                   const now = new Date().toISOString(); // Get current timestamp in ISO format

                    const progressData = {
                        time: currentTime,
                        timestamp: now
                    };

                   localStorage.setItem(VIDEO_PROGRESS_KEY_PREFIX + currentVideoId, JSON.stringify(progressData));
                   // console.log('Progress updated:', currentTime, 'seconds at', now); // Avoid excessive logging

                    // --- User Progress Tracking Logic ---
                    if (event.data === YT.PlayerState.ENDED) {
                        console.log('Video ended.');
                         // Mark this video as completed for the logged-in user
                         markVideoAsCompleted(currentVideoId);

                         // Remove saved progress so it starts from beginning next time
                         localStorage.removeItem(VIDEO_PROGRESS_KEY_PREFIX + currentVideoId);
                         console.log('Removed saved progress for ended video.');
                          const resumeMessageElement = document.getElementById('resumeMessage');
                         if (resumeMessageElement) {
                             resumeMessageElement.style.display = 'none'; // Hide resume message
                         }
                    }
              } else {
                  // Stop timer if video is not playing, paused, or ended (e.g., buffering)
                   // This clearInterval was removed in a previous step, let's add it back to be safe
                   // clearInterval(saveProgressTimer); // Removed for now as saving happens on pause/end too
              }
          }

         // --- User Progress Tracking Logic ---
          function markVideoAsCompleted(videoId) {
              const loggedInUsername = localStorage.getItem('loggedInUsername') || (localStorage.getItem('adminAuthenticated') ? 'Admin' : null); // Get username, null if guest
               if (!loggedInUsername || loggedInUsername === 'Guest') {
                   console.log("Cannot mark video as completed: User not logged in.");
                   return; // Don't track progress for guests
               }

              const userProgressKey = USER_PROGRESS_KEY_PREFIX + loggedInUsername;
              let progressData = JSON.parse(localStorage.getItem(userProgressKey)) || {};

               // Check if the video is already marked as completed to avoid unnecessary saves
               if (!progressData[videoId] || !progressData[videoId].completed) {
                    // Mark the video as completed
                    progressData[videoId] = { completed: true, completedTimestamp: new Date().toISOString() };

                    localStorage.setItem(userProgressKey, JSON.stringify(progressData));
                    console.log(`Marked video ${videoId} as completed for ${loggedInUsername}.`);

                    // Optional: Trigger a dashboard progress update if the user is viewing it
                    // This is complex for a pure frontend app, usually handled by state management or backend.
                    // For now, the dashboard will update on refresh.
               } else {
                   console.log(`Video ${videoId} already marked as completed for ${loggedInUsername}.`);
               }
          }


     </script>

</body>
</html>